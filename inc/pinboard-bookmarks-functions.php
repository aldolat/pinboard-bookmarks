<?php
/**
 * Prevent direct access to this file.
 *
 * @since 1.0
 */
if ( ! defined( 'WPINC' ) ) {
   exit( 'No script kiddies please!' );
}

function pinboard_bookmarks_get_tags_for_url( $tags_list ) {
    $tags_for_url = '';

    $tags_list = pinboard_bookmarks_sanitize_tags_list( $tags_list );

    // If we have a space separated list of tags
    if ( strpos( $tags_list, ' ' ) ) {
        $tags_list = explode( ' ', $tags_list );
        foreach ( $tags_list as $single_tag ) {
            $tags_for_url .= '/t:' . $single_tag;
        }
    // Else if we have a comma separated list of tags
    } else if ( strpos( $tags_list, ',' ) ) {
        $tags_list = explode( ',', $tags_list );
        foreach ( $tags_list as $single_tag ) {
            $tags_for_url .= '/t:' . $single_tag;
        }
    // Else we have a single tag
    } else {
        $tags_for_url = '/t:' . $tags_list;
    }
    return $tags_for_url;
}

function pinboard_bookmarks_sanitize_tags_list( $tags_list ) {
    // Replace comma+space and space+comma into a space
    $tags_list = str_replace( array( ', ', ' ,' ), ' ', $tags_list );
    // Replace 2+ spaces into a single space
    $tags_list = preg_replace( '!\s+!', ' ', $tags_list );
    // Remove any trailing space
    $tags_list = trim( $tags_list );

    return $tags_list;
}

/**
 * Check for the cache lifetime in the database and set it to 3600 seconds minimum.
 *
 * @since 1.0
 * @param int $seconds The number of seconds of feed lifetime
 * @return int
 * @link http://codex.wordpress.org/Plugin_API/Filter_Reference/wp_feed_cache_transient_lifetime Codex Documentation
 */
function pinboard_bookmarks_cache_handler( $seconds ) {
	$options = (array) get_option( 'widget_pinboard-bookmarks-widget' );
	$seconds = isset( $options['time'] ) ? $options['time'] : 3600;
	return $seconds;
}

/**
 * Return an HTML comment with the version of the plugin.
 *
 * @since 1.0
 * @return string $output The HTML comment.
 */
function pinboard_bookmarks_get_generated_by() {
	$output = "\n" . '<!-- Generated by Pinboard Bookmarks ' . PB_PLUGIN_VERSION . ' -->' . "\n";
	return $output;
}

/**
 * Add links to plugins list line.
 *
 * @since 1.0
 */
function pinboard_bookmarks_add_links( $links, $file ) {
	if ( $file == plugin_basename( __FILE__ ) ) {
		$rate_url = 'https://wordpress.org/support/plugin/' . basename( dirname( __FILE__ ) ) . '/reviews/#new-post';
		$links[] = '<a target="_blank" href="' . $rate_url . '" title="' . esc_attr__( 'Click here to rate and review this plugin on WordPress.org', 'pinboard-bookmarks' ) . '">' . esc_html__( 'Rate this plugin', 'pinboard-bookmarks' ) . '</a>';
	}
	return $links;
}
